name: main
on: [pull_request, push]
jobs:
  pre-process:
    name: Pre process
    runs-on: ubuntu-latest
    outputs:
      were-only-docs-updated: ${{ steps.were-only-docs-updated-action.outputs.were-only-docs-updated }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 2.  
      - name: Get commit range
        id: get-commit-range-action
        uses: ./.github/actions/get-commit-range-action
      - name: Were only docs updated
        id: were-only-docs-updated-action
        uses: ./.github/actions/were-only-docs-updated-action
        with:
          commit-range: ${{ steps.get-commit-range-action.outputs.commit-range }}
  check-header:
    name: Check Header
    runs-on: ubuntu-latest
    needs: pre-process
    if: needs.pre-process.outputs.were-only-docs-updated != 'yes'
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 2.  
      - name: Get commit range
        id: get-commit-range-action
        uses: ./.github/actions/get-commit-range-action
      - name: Check header
        run: |
          git clone --branch=devops https://github.com/vmware/singleton.git devops
          cp $GITHUB_WORKSPACE/devops/check_headers.py .
          chmod +x check_headers.py
          git diff ${{ steps.get-commit-range-action.outputs.commit-range }} --stat
          git diff --name-only --diff-filter=d ${{ steps.get-commit-range-action.outputs.commit-range }}
          python ./check_headers.py -f "$(git diff --name-only --diff-filter=d ${{ steps.get-commit-range-action.outputs.commit-range }})"
  unit-test:
    name: Unit Test
    runs-on: ubuntu-latest
    needs: pre-process
    if: needs.pre-process.outputs.were-only-docs-updated != 'yes'
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.16.x
      - name: Unit test
        run: |
          make test
      - name: Coverage
        run: |
          make coverage
      - name: Upload Codecov report for go-coverage
        uses: codecov/codecov-action@v2
        with:
          files: ./cover.out
          flags: coverage

  security-analysis:
    name: Security Analysis
    runs-on: ubuntu-latest
    needs: pre-process
    if: needs.pre-process.outputs.were-only-docs-updated != 'yes'
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.16.x
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: go
      - name: Autobuild
        uses: github/codeql-action/autobuild@v1
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: pre-process
    if: needs.pre-process.outputs.were-only-docs-updated != 'yes'
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.16.x
      - name: Set up JDK 8
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '8'
      - name: Smoke Test
        run: |
          java -version
          wget https://services.gradle.org/distributions/gradle-5.6.2-bin.zip -P /tmp
          sudo unzip -d /opt/gradle /tmp/gradle-*.zip
          ls /opt/gradle/gradle-5.6.2
          export GRADLE_HOME=/opt/gradle/gradle-5.6.2
          export PATH=${GRADLE_HOME}/bin:${PATH}
          gradle -v
          git clone --branch=devops https://github.com/vmware/singleton.git devops
          cp -r $GITHUB_WORKSPACE/devops/autotest/service/goservice/l10n/bundles $GITHUB_WORKSPACE/tests/testdata/bundles
          cp -r $GITHUB_WORKSPACE/devops/autotest/service/goservice/l10n/https $GITHUB_WORKSPACE/tests/testdata/https
          cd $GITHUB_WORKSPACE/config && mv config_template.yaml config.yml
          sed -i 's/BasePath:  ###/BasePath: tests\/testdata\/bundles/' config.yml
          sed -i 's/CertFile: ###/CertFile: tests\/testdata\/https\/server.pem/' config.yml
          sed -i 's/KeyFile: ###/KeyFile: tests\/testdata\/https\/server.key/' config.yml
          cat $GITHUB_WORKSPACE/config/config.yml
          cd $GITHUB_WORKSPACE && make build
          $GITHUB_WORKSPACE/builds/singleton-linux-amd64 --config=$GITHUB_WORKSPACE/config/config.yml &
          cd $GITHUB_WORKSPACE/devops/autotest/service/goservice && gradle build
          "$JAVA_HOME/bin/java" -cp "./target/*:./resource/*:./" org.testng.TestNG -d test-output testng.xml || true

